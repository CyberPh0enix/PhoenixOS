import { useState, useEffect } from "react";
import { encodeSecret } from "./crypto";

const EXPLOIT_CONFIG = {
  sequence: "m a t r i x",
  onionUrl: "/api/darkmarket/v1/root-override",
};

export const devExploitManager = {
  triggerDevMode: () => {
    localStorage.setItem(
      "_SYS_SEC_TOKEN",
      encodeSecret(EXPLOIT_CONFIG.sequence),
    );

    fetch(EXPLOIT_CONFIG.onionUrl, {
      method: "POST",
      headers: {
        "X-Diagnostic-Hint": "Check LocalStorage. Trace _SYS_SEC_TOKEN.",
        "X-Action": "Type decoded sequence on desktop to override.",
      },
    }).catch(() => {});
  },
};

export const useDevExploitSequence = (activeApp, onUnlock) => {
  const [keyIndex, setKeyIndex] = useState(0);

  useEffect(() => {
    const handleKeyDown = (e) => {
      if (activeApp) return;

      const storedToken = localStorage.getItem("_SYS_SEC_TOKEN");
      if (!storedToken) return;

      const char = e.key.toLowerCase();
      if (char === EXPLOIT_CONFIG.sequence[keyIndex]) {
        const nextIndex = keyIndex + 1;
        if (nextIndex === EXPLOIT_CONFIG.sequence.length) {
          localStorage.setItem(
            "_SYS_ROOT_UNLOCKED",
            encodeSecret(EXPLOIT_CONFIG.sequence),
          );
          setKeyIndex(0);
          onUnlock?.();
        } else {
          setKeyIndex(nextIndex);
        }
      } else {
        setKeyIndex(0);
      }
    };

    window.addEventListener("keydown", handleKeyDown);
    return () => window.removeEventListener("keydown", handleKeyDown);
  }, [keyIndex, activeApp, onUnlock]);
};

export const heistCommand = {
  hidden: true,
  execute: async (args, { addToHistory, profile, refreshProfile }) => {
    const requiredHash = encodeSecret(EXPLOIT_CONFIG.sequence);
    if (localStorage.getItem("_SYS_ROOT_UNLOCKED") !== requiredHash) {
      addToHistory("error", `bash: ${args[0]}: command not found`);
      return;
    }

    if (!args[1] || isNaN(args[1])) {
      addToHistory("error", "Usage: heist <amount>");
      return;
    }

    const requestedAmount = parseInt(args[1]);

    // mint the credits locally
    if (profile) {
      const newBalance = (profile.credits || 0) + requestedAmount;
      const updatedProfile = { ...profile, credits: newBalance };
      localStorage.setItem("ph0enix_profile", JSON.stringify(updatedProfile));
      if (refreshProfile) await refreshProfile();

      addToHistory("warning", "WARNING: BYPASSING CENTRAL BANK NODE.");
      addToHistory(
        "success",
        `CREDITS ACQUIRED: ${requestedAmount} locally minted.`,
      );
    } else {
      addToHistory("error", "SYSTEM ERR: Local profile not found.");
    }
  },
};
